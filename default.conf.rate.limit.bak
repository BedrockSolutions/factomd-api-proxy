limit_req_zone GLOBAL_TRANSACTIONS zone=tx_rate_limit:1m rate=3r/m;

lua_need_request_body on;
lua_shared_dict TX_METHODS 1m;

init_by_lua_block {
  local tx_methods = ngx.shared.TX_METHODS
  tx_methods:set("reveal-chain", true)
  tx_methods:set("reveal-entry", true)
}

server {
    keepalive_timeout 0;
    listen 80 default_server;
    server_name _;

    location = /v2 {
      rewrite_by_lua_block {
        local function send_error(status, message)
          ngx.status = status
          ngx.say('{"jsonrpc":"2.0","id":null,"error":{"code":-32600,"message":"' .. message .. '"}}')
          ngx.exit(status)
        end

        local function get_api_method(body)
          if not body or body == '' then
            send_error(400, 'Missing request body')
          end

          local method = string.match(body, '"method": "([%a-]+)"')

          if not method or method == '' then
            send_error(400, 'No method found')
          end

          return method
        end

        ngx.log(ngx.ERR, "BEGIN")
        local method = get_api_method(ngx.req.get_body_data())

        ngx.log(ngx.ERR, '"' .. method .. '"')

        if ngx.shared.TX_METHODS:get(method) then
          ngx.log(ngx.ERR, '!!!!! Method on the list !!!!')
          ngx.var.rate_limit_zone = 'tx_rate_limit'
        end

        ngx.log(ngx.ERR, "END")
      }

      limit_req zone=$rate_limit_zone;
      proxy_pass http://courtesy-node.factom.com;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}
